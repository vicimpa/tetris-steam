var Z=Object.defineProperty;var Q=(n,t,e)=>t in n?Z(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var h=(n,t,e)=>(Q(n,typeof t!="symbol"?t+"":t,e),e),W=(n,t,e)=>{if(!t.has(n))throw TypeError("Cannot "+e)};var p=(n,t,e)=>(W(n,t,"read from private field"),e?e.call(n):t.get(n)),k=(n,t,e)=>{if(t.has(n))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(n):t.set(n,e)},u=(n,t,e,s)=>(W(n,t,"write to private field"),s?s.call(n,e):t.set(n,e),e);const V=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerpolicy&&(r.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?r.credentials="include":i.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}};V();function ee(n=Math.random()*1e13){var t=4294967295,e=123456789+n&t,s=987654321-n&t;return function(){s=36969*(s&65535)+(s>>>16)&t,e=18e3*(e&65535)+(e>>>16)&t;var i=(s<<16)+(e&65535)>>>0;return i/=4294967296,i}}let N=+location.hash.slice(1)|0,G=Math.random();const q=()=>{location.hash=`#${N=G*1e8|0}`};(!N||isNaN(N))&&q();const F=ee(N);G=F();function a(n){return(t,e,s)=>{const{value:i}=s||{};if(typeof i!="function")return s;const r=Symbol(e);return{get(){return this[r]||(this[r]=i.bind(n||this))}}}}const B=(n,t)=>{for(const e in n)typeof n[e]=="object"?B(n[e],t[e]):t[e]=n[e]},S=(n,t={},...e)=>{const s=document.createElement(n);B(t,s);for(const i of e)s.appendChild(i);return s};class X{constructor(t,e){this.x=t,this.y=e}}function m(n,t){return new X(n,t)}var te=Object.defineProperty,ie=Object.getOwnPropertyDescriptor,j=(n,t,e,s)=>{for(var i=s>1?void 0:s?ie(t,e):t,r=n.length-1,o;r>=0;r--)(o=n[r])&&(i=(s?o(t,e,i):o(i))||i);return s&&i&&te(t,e,i),i};class M{constructor(t,e){h(this,"width",0);h(this,"height",0);h(this,"map");this.map=new Uint8Array(t*e),this.width=t,this.height=e}get clonedMap(){return new Uint8Array(this.map)}entries(){const{width:t,map:e}=this,s=new Array(e.length);for(let i=0;i<e.length;i++){let r=i%t,o=(i-r)/t,c=e[i];s[i]=[r,o,c]}return s}index(t){const{width:e,height:s}=this;if(t instanceof X){const{x:i,y:r}=t;return i<0||i>e-1||r<0||r>s-1?-1:r*this.width+i}return t}get(t){return this.map[this.index(t)]}set(t,e){return this.map[this.index(t)]=e|0}}j([a()],M.prototype,"entries",1);j([a()],M.prototype,"index",1);j([a()],M.prototype,"get",1);j([a()],M.prototype,"set",1);const A=class extends M{constructor(){super(...arguments);h(this,"x",0);h(this,"y",0);h(this,"delta",0);h(this,"previewState",{x:this.x,y:this.y,map:this.clonedMap})}getMinY(){let e=1/0;for(let s=0;s<this.width;s++)for(let i=0;i<this.height;i++)if(this.get(m(s,i))&&i<e){e=i;break}return e}getMaxY(){let e=-1/0;for(let s=0;s<this.width;s++)for(let i=this.height-1;i>=0;i--)if(this.get(m(s,i))&&i>e){e=i;break}return e}static make(...e){var c;let s=1,i=e.length,r=0;for(let l of e)l.length>r&&(r=l.length);const o=new A(r,i);for(let[l,g]of o.entries()){const v=((c=e[g])==null?void 0:c[l])||" ";o.set(m(l,g),v==" "?0:s)}return o}save(){this.previewState={x:this.x,y:this.y,map:this.clonedMap}}back(){this.x=this.previewState.x,this.y=this.previewState.y,this.map=this.previewState.map}move(e,s){return this.save(),this.x+=e,this.y+=s,s&&(this.delta=1),this}haveCollizion(e,s=!1){for(let[i,r,o]of this.entries())if(!!o&&(i+=this.x,r+=this.y,i<0||i>=e.width||s&&r<0||r>=e.height||e.get(m(i,r))))return!0;return!1}rotate(){this.save();const e=this.clone(),{height:s,width:i}=this;this.width=s,this.height=i;for(let[r,o,c]of e.entries())this.set(m(s-1-o,r),c);return this}clone(){const{width:e,height:s}=this,i=new A(e,s);return i.x=this.x,i.y=this.y,i.map=this.clonedMap,i}color(e=1){for(let[s,i,r]of this.entries())this.set(m(s,i),r?e:0);return this}position(e,s){return this.x=e,this.y=s,this}};let f=A;h(f,"colors",["transparent","#00EEEE","#0008EE","#EE9500","#EEEE00","#00EE00","#9508EE","#EE0000"]);const se=f.make("    ","####","    ","    ").color(1),re=f.make("##","##").color(4),ne=f.make("   ","###"," # ").color(6),oe=f.make(" # "," # ","## ").color(2),he=f.make(" # "," # "," ##").color(3),ce=f.make(" ##","## ","   ").color(5),ae=f.make("## "," ##","   ").color(7),I=[se,re,ne,oe,he,ce,ae];function K(){let n=F()*4|0;const t=I[F()*I.length|0].clone();for(;n--;)t.rotate();return t}var le=Object.defineProperty,pe=Object.getOwnPropertyDescriptor,_=(n,t,e,s)=>{for(var i=s>1?void 0:s?pe(t,e):t,r=n.length-1,o;r>=0;r--)(o=n[r])&&(i=(s?o(t,e,i):o(i))||i);return s&&i&&le(t,e,i),i};class w extends M{constructor(e=10,s=20){super(e,s);h(this,"figures",[])}entriesRender(){return this.entries().map(([e,s,i])=>{for(let r of this.figures){if(e<r.x||e>r.x+r.width||s<r.y||s>r.y+r.height)continue;const o=r.get(m(e-r.x,s-r.y));typeof o=="number"&&(i=i||o)}return[e,s,i]})}add(e){const{figures:s}=this;s.indexOf(e)==-1&&s.push(e)}remove(e){if(!e){this.figures.splice(0);return}const{figures:s}=this,i=s.indexOf(e);i!=-1&&s.splice(i,1)}fix(e){this.remove(e);for(let[s,i,r]of e.entries())!r||(s+=e.x,i+=e.y,this.set(m(s,i),r))}checkClear(e={count:0}){for(let s=0;s<this.height;s++){let i=!0;for(let r=0;r<this.width;r++)if(!this.get(m(r,s))){i=!1;break}if(i){const r=s;for(let[o,c,l]of this.entries())c>=r||this.set(m(o,c+1),l);e.count++,this.checkClear(e);break}}return e.count}update(){}render(){}}_([a()],w.prototype,"entriesRender",1);_([a()],w.prototype,"add",1);_([a()],w.prototype,"remove",1);_([a()],w.prototype,"fix",1);_([a()],w.prototype,"checkClear",1);_([a()],w.prototype,"update",1);_([a()],w.prototype,"render",1);var fe=Object.defineProperty,ue=Object.getOwnPropertyDescriptor,H=(n,t,e,s)=>{for(var i=s>1?void 0:s?ue(t,e):t,r=n.length-1,o;r>=0;r--)(o=n[r])&&(i=(s?o(t,e,i):o(i))||i);return s&&i&&fe(t,e,i),i};class D{constructor(t){h(this,"elem",document.createElement("canvas"));h(this,"ctx",this.elem.getContext("2d"));h(this,"size",20);h(this,"padding",30);h(this,"time",performance.now());h(this,"deltaTime",0);this.map=t;const{size:e}=this,{width:s,height:i}=t,r=s*e,o=i*e;this.elem.width=r,this.elem.height=o,this.elem.style.width=`${r}px`,this.elem.style.height=`${o}px`,this.elem.style.border="2px solid #999",this.elem.style.imageRendering="pixelated"}append(t){if(t instanceof HTMLElement){t.appendChild(this.elem);return}const e=document.querySelector(t);if(!e)throw new Error("No find element!");return this.append(e)}resize(){const{padding:t}=this,{parentElement:e}=this.elem;if(!e)return;const{offsetWidth:s,offsetHeight:i}=e,{offsetWidth:r,offsetHeight:o}=this.elem,c=Math.min((s-t*2)/r,(i-t*2)/o);this.elem.style.transform=`scale(${c})`}render(){const{size:t,ctx:e,map:s,time:i}=this,{width:r,height:o}=this.map,c=performance.now();this.deltaTime=c-i,this.time=c,this.deltaTime>100&&(this.deltaTime=0),e.clearRect(0,0,r*t,o*t);for(let[l,g,v]of s.entries()){const x=f.colors[v]||"transparent",E=l*t,O=g*t;e.beginPath(),e.strokeStyle="#dddddd",e.fillStyle=x,e.strokeRect(E,O,t,t),e.fillRect(E+1,O+1,t-1,t-1),e.closePath()}for(let l of s.figures){let{x:g,y:v}=l;g*=t,v*=t;for(let[x,E,O]of l.entries()){const L=f.colors[O]||"transparent",J=l.delta*t;x*=t,E*=t,e.beginPath(),e.strokeStyle="#dddddd",e.fillStyle=L,e.fillRect(x+g+1,E+v-J+1,t-1,t-1),e.closePath()}l.delta>0?l.delta-=.15:l.delta=0}}}H([a()],D.prototype,"append",1);H([a()],D.prototype,"resize",1);H([a()],D.prototype,"render",1);const Y=new Map;addEventListener("keydown",({code:n})=>{Y.set(n,!0)});addEventListener("keyup",({code:n})=>{Y.set(n,!1)});var z,$,b;class de{constructor(t){k(this,z,void 0);k(this,$,!1);k(this,b,0);u(this,z,t)}isDown(){return!!p(this,z).filter(t=>Y.get(t)).length}isUp(){return!this.isDown()}isSingle(){return!p(this,$)&&this.isDown()?(u(this,$,!0),!0):(this.isDown()||u(this,$,!1),!1)}isEvery(t=0){const e=performance.now();return this.isDown()?p(this,b)?p(this,b)+t<e?(u(this,b,e),!0):!1:(u(this,b,e),!0):(u(this,b,0),!1)}}z=new WeakMap,$=new WeakMap,b=new WeakMap;const me=n=>Object.entries(n).reduce((t,[e,s])=>(t[e]=new de(s),t),{});var ge=Object.defineProperty,we=Object.getOwnPropertyDescriptor,T=(n,t,e,s)=>{for(var i=s>1?void 0:s?we(t,e):t,r=n.length-1,o;r>=0;r--)(o=n[r])&&(i=(s?o(t,e,i):o(i))||i);return s&&i&&ge(t,e,i),i},U,C,d,P,R;class y{constructor(t){k(this,C,0);k(this,d,0);k(this,P,+((U=localStorage.getItem("hiscore"))!=null?U:"0"));k(this,R,me({keyUp:["ArrowUp","KeyW"],keyDown:["ArrowDown","KeyS"],keyLeft:["ArrowLeft","KeyA"],keyRight:["ArrowRight","KeyD"],pause:["Escape","Space"]}));h(this,"appendScores",[0,100,300,700,1500]);h(this,"figure");h(this,"nexFigure");h(this,"map",new w);h(this,"next",new w(4,4));h(this,"renderer",new D(this.map));h(this,"rendererNext",new D(this.next));h(this,"work",!1);h(this,"isDown",!1);h(this,"pause",!0);h(this,"tickCount",0);h(this,"previewTick",performance.now());h(this,"previewMove",performance.now());h(this,"previewTime",performance.now());h(this,"gapElement",S("div",{className:"gap"}));h(this,"scoreElement",S("p",{className:"score",innerText:`${this.score}`}));h(this,"hiScoreElement",S("p",{className:"score",innerText:`${p(this,P)}`}));h(this,"linesElement",S("p",{className:"score",innerText:`${p(this,d)}`}));h(this,"levelElement",S("p",{className:"score",innerText:`${p(this,d)/10|0}`}));h(this,"pauseElement",S("p",{className:"pause",innerText:"\u041F\u0430\u0443\u0437\u0430 (Esc | Space)"}));h(this,"pauseButton",S("button",{innerText:"\u041F\u0430\u0443\u0437\u0430 (Esc)"}));h(this,"githubLink",S("a",{href:"https://github.com/vicimpa/tetris",innerText:"GitHub"}));const e=document.querySelector(t),s=e.querySelector("#content"),i=e.querySelector("#side");this.newFigure(),this.renderer.append(s),i.appendChild(this.scoreElement),i.appendChild(this.hiScoreElement),i.appendChild(this.linesElement),i.appendChild(this.levelElement),this.rendererNext.append(i),i.appendChild(this.pauseButton),s.appendChild(this.pauseElement),this.resize(e),i.appendChild(this.gapElement),i.appendChild(this.githubLink),addEventListener("resize",this.resize.bind(this,e)),addEventListener("blur",()=>this.pause=!0),this.pauseButton.addEventListener("click",()=>this.pause=!this.pause)}get score(){return p(this,C)}set score(t){u(this,C,t),this.scoreElement.innerText=`${t}`,p(this,C)>p(this,P)&&(u(this,P,p(this,C)),this.hiScoreElement.innerText=`${p(this,P)}`,localStorage.setItem("hiscore",`${p(this,C)}`))}get lines(){return p(this,d)}set lines(t){u(this,d,t),this.linesElement.innerText=`${p(this,d)}`,this.levelElement.innerText=`${p(this,d)/10|0}`}get speed(){return 600-(p(this,d)/10|0)*15}resize(t){const{parentElement:s}=t;if(!s)return;const{offsetWidth:i,offsetHeight:r}=s,{offsetWidth:o,offsetHeight:c}=t,l=Math.min((i-20*2)/o,(r-20*2)/c);t.style.transform=`scale(${l})`}rotate(){this.figure.rotate(),this.figure.haveCollizion(this.map)&&this.figure.back(),this.renderer.render()}move(t){this.figure.move(t,0),this.figure.haveCollizion(this.map)&&this.figure.back(),this.renderer.render()}newFigure(){var s;this.figure&&this.map.remove(this.figure),this.figure=(s=this.nexFigure)!=null?s:K(),this.nexFigure=K(),this.next.remove(),this.next.add(this.nexFigure),this.map.add(this.figure);const t=-this.figure.height+this.figure.getMinY(),e=Math.round(this.map.width/2-this.figure.width/2);this.figure.position(e,t),this.renderer.render(),this.rendererNext.render()}start(){this.work||(this.work=!0,this.tick())}stop(){!this.work||(this.work=!1)}checkPause(){const t="show",{classList:e}=this.pauseElement;this.pause&&!e.contains(t)&&e.add(t),!this.pause&&e.contains(t)&&e.remove(t)}tick(){var O;if(!this.work)return;const{keyUp:t,keyDown:e,keyLeft:s,keyRight:i,pause:r}=p(this,R);requestAnimationFrame(this.tick);const{figure:o}=this,c=performance.now(),l=c-this.previewTime;this.previewTime=c,l>100&&!this.pause&&(this.pause=!0),r.isSingle()&&(this.pause=!this.pause),this.checkPause();const{previewTick:g,previewMove:v}=this;if(this.pause){this.previewTick=c,this.previewMove=c;return}let x=this.speed,E=100;if(e.isDown()&&(x*=.1),t.isSingle()&&this.rotate(),(s.isSingle()||i.isSingle())&&(this.previewMove=c),e.isSingle()&&(this.previewTick=c-x),c>=v+E&&(s.isDown()?(this.move(-1),this.previewMove=c):i.isDown()?(this.move(1),this.previewMove=c):this.previewMove=c-E),c>=g+x&&(this.tickCount+=1,this.previewTick=c,o.move(0,1),o.haveCollizion(this.map))){if(o.back(),this.figure.haveCollizion(this.map,!0)){this.stop(),alert(`Game Over! Score ${this.score}`),q(),location.reload();return}this.map.fix(this.figure);const L=this.map.checkClear();this.lines+=L,this.score+=(O=this.appendScores[L])!=null?O:1e4,this.newFigure()}this.renderer.render()}}C=new WeakMap,d=new WeakMap,P=new WeakMap,R=new WeakMap;T([a()],y.prototype,"resize",1);T([a()],y.prototype,"rotate",1);T([a()],y.prototype,"move",1);T([a()],y.prototype,"newFigure",1);T([a()],y.prototype,"start",1);T([a()],y.prototype,"stop",1);T([a()],y.prototype,"checkPause",1);T([a()],y.prototype,"tick",1);new y("#app").start();
